## 3.1 SQL语言概述
### 一、什么是SQL？
#SQL (Structured Query Language，结构化查询语言)是一种对关系数据库进行访问是护具操作语言。
### 二、SQL标准发展历史
- 20世纪70年代由IBM公司研制出的SEQUEL语言演变出SQL语言
- 1979年ORACLE公司首先推出商用SQL
- 1986美国国家标准局批准了SQL作为关系型数据库语言的ANSI标准
- 1987年国际标准化组织（ISO）将其采纳为国际标准SQL86。
- ISO先后推出国际标准 SQL-89、SQL-92、SQL:1999、SQL:2003、SQL:2006、SQL:2008、SQL:2011等，目前最新版本为SQL:2023。
### 三、SQL应用情况
主流的关系型数据库管理系统均支持SQL标准语言实现数据库操作，其中一些厂商数据库管理系统对SQL语句进行了功能扩展，如SybaseASE、Microsoft SQL Server将SQL操作语言扩展为 #Transaction-SQL 语言；Oracle Database将SQL操作语言扩展为 #PL/SQL 语言。
### 四、SQL语言特点
- 一体化
- 使用方式灵活
- 非过程化
- 语言语句简单
### 五、SQL对关系数据库的操作原理
SQL主要操作功能：
- 数据库对象创建、修改、删除
- 数据库表的数据插入、修改、删除、查询、统计
- 存储过程、触发器、函数等程序执行
- 数据库权限、角色、用户等管理
SQL的执行过程：
【数据库应用程序】<提交SQL>【DBMS】(执行SQL)<I/O>【数据库】<将数据经由DBMS返回结果给>【数据库应用程序】
### 六、SQL语言语句类型
1. #数据定义语言 (Data Definition Language， #DDL)是SQL语言中用于创建、修改或删除数据库对象的语句。
	- `CREATE DATABASE`-创建新数据库
	- `DROP DATABASE`-删除数据库
	- `ALTER DATABASE`-修改数据库属性
	- `CREATE TABLE`-修改数据库表结构
	- `DROP TABEL`-删除表
	- `CREATE INDEX`-创建索引
	- `DROP INDEX`-删除索引
2. #数据操纵语言 (Data Manipulation Language， #DML)是SQL语言中用于增添、修改、删除数据的语句。
	- `INSERT`-向数据库表中插入数据
	- `UPDATE`-更新数据库表中的数据
	- `DELETE`-从数据库表中删除数据
3. #数据查询语言 (Data Query Language， #DQL)是SQL语言中用于对数据库进行查询的语句。
4. #数据控制语言(Data Control Language， #DCL)是用于对数据库对象访问权进行控制的SQL语句。
	- `GRANT`-授予用户对数据库对象的权限
	- `DENY`-拒绝授予用户对数据库对象的权限
	- `REVOKE`-撤销用户对数据库对象的权限
5. #事物处理语言 (Transaction Process Language, #TPL)是SQL语言中用于数据库内部事物处理的语句。
	- `BEGIN TRANSACTION`-开始事物
	- `COMMIT`-提交事物
	- `ROLLBACK`-回滚事物
6. #游标控制语言 (Cursor Control Language， #CCL)是SQL语言中用于数据库游标操作的语句。
	- `DECLARE CURSOR`-定义游标
	- `FETCH INTO`-提交游标数据
	- `CLOSE CURSOR`-关闭游标
### 七、SQL语言的数据类型
1. SQL语言基本数据类型
	- 字符：CHAR、VARCHAR、TEXT
	- 整数：SMALLINT、INTEGER
	- 浮点数：NUMBER(n,d)、FLOAT(n,d)
	- 日期：DATE、DATETIME
	- 货币：MONEY
2. 不同数据库所支持的数据类型
	1. [PostgreSQL支持的数据类型-官网](http://www.postgres.cn/docs/14/datatype.html)  [PostgreSQL支持的数据类型-菜鸟教程](https://www.runoob.com/postgresql/postgresql-data-type.html#:~:text=PostgreSQL%20%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%201%20%E6%97%A5%E6%9C%9F%2F%E6%97%B6%E9%97%B4%E7%B1%BB%E5%9E%8B%20%E4%B8%8B%E8%A1%A8%E5%88%97%E5%87%BA%E4%BA%86%20PostgreSQL%20%E6%94%AF%E6%8C%81%E7%9A%84%E6%97%A5%E6%9C%9F%E5%92%8C%E6%97%B6%E9%97%B4%E7%B1%BB%E5%9E%8B%E3%80%82%20%E5%B8%83%E5%B0%94%E7%B1%BB%E5%9E%8B,uuid%20%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E7%94%A8%E6%9D%A5%E5%AD%98%E5%82%A8%20RFC%204122%EF%BC%8CISO%2FIEF%209834-8%3A2005%20%E4%BB%A5%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%A0%87%E5%87%86%E5%AE%9A%E4%B9%89%E7%9A%84%E9%80%9A%E7%94%A8%E5%94%AF%E4%B8%80%E6%A0%87%E8%AF%86%E7%AC%A6%EF%BC%88UUID%EF%BC%89%E3%80%82%20%EF%BC%88%E4%B8%80%E4%BA%9B%E7%B3%BB%E7%BB%9F%E8%AE%A4%E4%B8%BA%E8%BF%99%E4%B8%AA%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B8%BA%E5%85%A8%E7%90%83%E5%94%AF%E4%B8%80%E6%A0%87%E8%AF%86%E7%AC%A6%EF%BC%8C%E6%88%96GUID%E3%80%82%20)
	2. [SQL Server支持的数据类型-微软官网](https://learn.microsoft.com/zh-cn/sql/t-sql/data-types/data-types-transact-sql?view=sql-server-ver16)  [SQL Server支持的数据类型-菜鸟教程](https://www.cainiaojc.com/sql/sql-server-data-types.html)
	3. [MySQL支持的数据类型-官网](https://dev.mysql.com/doc/refman/5.7/en/data-types.html)  [MySQL支持的数据类型-菜鸟教程](https://www.runoob.com/mysql/mysql-data-types.html)
## 3.2 数据定义SQL语句
### 一、数据库操作SQL语句
1. 增 `CREATE DATABASE <数据库名>;`
2. 删 `DROP DATABASE <数据库名>;`
3. 改 `ALTER DATABASE <数据库名> <修改内容>;`
### 二、数据库表创建SQL语句
1. `CREATE TABLE <表名>(<列名1> <数据类型> [完整性约束],<列名2> <数据类型> [完整性约束],<列名3> <数据类型> [完整性约束],...);`
2. 完整性约束
	- `PRIMARY KEY`-主键
	- `NOT NULL`-非空值
	- `NULL`-空值
	- `UNIQUE`-值唯一
	- `CHECK`-有效性检查
	- `DEFAULT`-缺省值
3. 表约束定义主键：使用列约束关键词`primary key`定义表的主键列只能定义单列主键，若要定义由多个列构成的[[第2章 数据库关系模型#^7ef9a5|复合主键]]，则需要使用表约束方式来定义。
	1. `CREATE TABLE <表名>(<列名1> <数据类型> [完整性约束],<列名2> <数据类型> [完整性约束],<列名3> <数据类型> [完整性约束],...CONSTRAINT <约束名> PRIMARY Key(列名1,列名2));`
	2. 使用表约束定义主键的优点
		- 便于定义复合主键
		- 可命名主键约束
		- 便于定义[[第2章 数据库关系模型#^ec2919|代理键]]
4. 表约束定义代理键：在一些关系表中，为了方便数据处理，可以使用代理键去替代复合主键。在SQL语句中，关系表的代理键采用表约束方式来定义。
	1. `CREATE TABLE <表名>(<代理键列名> <Serial数据类型> NOT NULL,<列名2> <数据类型> [完整性约束],<列名3> <数据类型> [完整性约束],...CONSTRAINT <约束名> PRIMARY Key(代理键列名));`
5. 表约束定义外键：在数据库中，一些关系表之间存在关联。在一个表中作为主键的列，在另外的关联表中则作为外键。
	1. `CREATE TABLE <表名>(<列名1> <数据类型> [完整性约束],<列名2> <数据类型> [完整性约束],<列名3> <数据类型> [完整性约束],...CONSTRAINT <约束名> FOREIGN Key(外键列));`
### 三、修改表结构SQL语句
1. 语句基本格式：`ALTER TABLE <表名> <修改方式>;`
2. 主要语句类型
	1. ADD，用于增加新列或列完整性约束 `ALTER TABLE <表名> ADD <新列名称> <数据类型> | [完整性约束];`
	2. DROP
		- 删除指定列 `ALTER TABLE <表名> DROP COLUMN <列名>;`
		- 删除列的完整性约束条件 `ALTER TABLE <表名> DROP CONSTRAINT <完整性约束名>;`
	3. RENAME
		- 修改表名 `ALTER TABLE <表名> RENAME TO <新表名>;`
		- 修改列名 `ALTER TABLE <表名> RENAME <原列名> TO <新列名>;`
	4. ALTER，用于修改列的数据类型 `ALTER TABLE <表名> ALTER COLUMN <列名> TYPE<新的数据类型>;`
### 四、删除表结构SQL语句
`DROP TABLE <表名>;`——**注意**：该语句将删除该表的所有数据及其结构。

### 五、索引
1. #索引 （Index）是一种按照关系表中指定列的取值顺序组织元组数据存储的数据结构，使用它可以加快表中数据的查询访问。
2. 索引的作用：支持对数据库表中数据快速查找，其机理类似图书目录可以快速定位章节内容。
3. 索引的优点：
	- 提高数据检索速度
	- 可快速连接关联表
	- 减少分组和排序时间
4. 索引的开销：
	- 创建和维护索引都需要较大开销
	- 索引为占用额外存储空间
	- 数据操纵因维护索引带来系统性能开销
5. 索引创建SQL语句 `create index <索引名> on <表名>(列名);`
6. 索引修改SQL语句 `alter index <索引名> <修改项>;`
7. 索引删除SQL语句 `drop index <索引名>;`
## 3.3 数据操纵SQL语句
1. 增`insert into <表名|视图名>[<列名表>] values (列值表);`
2. 删 `delete from <表名|视图名> [where <条件表达式>];`
3. 改 `update <表名|视图名> set <列名1> = <表达式1>[,<列名2> = <表达式2>...] [where <条件表达式>];`
## 3.4 数据查询SQL语句
### 一、数据查询SQL语句格式
```sql
select [all|distinct] <目标列> [,<目标列>...]
[into <新表>]
from <表名|视图名> [,<表名|视图名>...]
[where <条件表达式>]
[group by <列名>[having <条件表达式>]]
[order by <列名> [asc|desc]];
```
### 二、从单个表读取指定列
在关系数据库中，最简单的数据查询操作就是从单个关系表中读取指定列的数据，即关系的投影操作。为了在结果集中过滤重复数据，可以在查询语句的输出列前加入`DISTINCT`关键字。`select [distinct] <列名> from <表名>;`
### 三、从单个表读取指定行
SQL查询语句也可以从一个关系表中读取满足条件的指定行数据，即完成关系数据的元组选择操作。`select * from <表名> where <条件表达式>;`
### 四、从单个表读取指定行和列
在SQL查询语句中，还可以从一个关系表中读取指定行与指定列范围内的数据。既完成关系的行选择，又完成关系的列投影操作。`select [distinct] <列名> from <表名> where <条件表达式>;`
### 五、Where条件子句
1. 在where子句中可以使用如下方式，指定范围数据。
	1. 使用`between...and` 关键词来限定列值范围，还可以使用关键词`like`与通配符来限定查询条件。
	2. 使用通配符来限定字符串数据范围。下划线（`_`）用于代表一个未指定的字符。百分号（`%`）用于代表一个或多个未指定的字符。
2. 在where子句中，还可以使用多个条件表达式，并通过逻辑运算符（`and/or/not`）连接操作，以及使用（`in\not in`）关键词，进一步限定结果集的数据范围。
### 六、对结果集进行排序
在select查询语句返回的结果集中，行的顺序是任意的。如果需要结果集排序，可以在select语句中加入`order by`关键字。在默认情况下，SQL查询的结果集是按指定列值的升序排列。可以使用关键词`ASC\DESC`选定排序是升序或降序。如果结果集需要按多个列排序，可以分别加入关键词改变。 `select * from <表名> order by <列名1> desc, <列名2> asc;`
### 七、SQL内置函数类型
SQL语言提供了大量内置函数，支持对select查询结果数据进行处理。
典型SQL内置函数类型如下：
1. 聚合函数：是一些对关系表中数值属性列进行计算并返回一个结果数值的函数。
	- `AVG()` 计算结果集指定列数据的平均值
	- `COUNT()` 计算结果集行数
	- `MIN()` 找出结果集指定列数据的最小值
	- `MAX()` 找出结果集指定列数据的最大值
	- `SUM()` 计算结果集指定列数据的总和
2. 算数函数
3. 字符串函数
4. 日期时间函数
5. 数据类型转换函数
### 八、SQL内置函数与分组统计
在SQL语言中，可使用内置函数对查询结果集进行分组数据统计。这是通过在select语句中加入 `group by`子语句来实现的。
`select 统计函数(目标列) from <表名> [where 条件] group by <目标列> [having 条件];`
### 九、子查询与多表关联
在实际应用中，通常需要关联多表才能获得所需的信息。在select查询语句中，可使用子查询方式实现多表关联查询。
`select <目标列>[, <目标列>...] from <表名> where <条件中嵌套另一关系表的select查询结果集>;`
### 十、使用连接关联多表查询
在使用多个表查询时，子查询只有在结果数据均来自一个表的情况下才有用。但如果需要从两个或多个表中获取结果数据，就不能使用子查询，而需要采用连接关联多表查询。
`select <目标列>[, <目标列>...] from <表名1>,<表名2>...<表名n> where <关系表之间的连接关联条件>;`
### 十一、内连接查询语句
在SQL语言中，实现多表关联查询还可以使用`join...on`关键词的语句格式。
`select <目标列>[,<目标列>...] form <表名1> join <表名2> on <连接条件>;`
在一些特殊情况下，如关联表中的一些行的主键与外键不匹配，查询结果集就会丢失部分数据。
### 十二、外连接查询数据
在SQL应用中，有时也希望输出那些不满足连接条件的元组数据。这时，可使用外连接方式实现。外连接有三种：
- left join： #左外连接 ，即使没有与右表关联列值匹配，也从左表返回所有的行。
- right join： #右外连接 ，即使没有与左表关联列值匹配，也从右表返回所有的行。
- full join： #全外连接 ，同时进行左连接和右连接，就返回所有行。
## 3.5 数据控制SQL语句
在SQL语言中， #数据控制SQL语句 是一种可对用户数据访问权进行控制的操作语句，它可以控制特定用户或角色对数据表、视图、存储过程、触发器等数据库对象的访问权限。
1. `grant` 由数据库对象创建者或管理员执行的权限授予语句，它可以把访问数据库对象权限授予其它用户或角色。`grant <权限列表> on <数据库对象> to <用户或角色> [with grant option];`
2. `revoke` 由数据库对象创建者或管理员执行的权限收回语句，它可以收回原授予给其它用户或角色的权限。`revoke <权限列表> on <数据库对象> to <用户或角色>;`
3. `deny` 用于拒绝给当前数据库内的用户或者角色授予权限，并防止用户或角色通过其组或角色成员继承权限。`deny <权限列表> on <数据库对象> to <用户或角色>;`
## 3.6 视图SQL语句
1. #视图 是一种通过基础表或其它视图构建的虚拟表。它本身没有自己的数据，而是使用了存储在基础表中的数据。当视图在数据库中创建后，用户可以像访问关系表一样去操作访问视图。
2. 创建视图 `create view <视图名>[ (列名1),(列名2)...] as <select查询>;`
3. 删除视图 `drop view <视图名>;`
4. 视图的作用
	1. 使用视图简化复杂SQL查询操作：数据库开发人员可以将复杂的SQL查询语句封装在视图内，外部程序只需要使用简单的视图访问方式，便可获取所需要的数据。
	2. 使用视图提高数据访问安全性：通过视图可以将数据表中敏感数据隐藏起来，外部用户无法得知数据表的完整数据，降低数据库被攻击的风险。此外，还可以保护用户隐私数据。
	3. 提供一定程度是数据逻辑独立性：通过视图，可提供一定程度的数据逻辑独立性。当数据表结构发生改变，只要视图结构不变，应用程序可以不作修改。
	4. 集中展示用户所感兴趣的特定数据：通过视图，可以将部分用户不关心的数据进行过滤，仅仅提供他们感兴趣的数据。